<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PagerDuty Event Generator</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/bvScwHL.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #048a24;
            color: white !important;
        }
        .card {
            background-color: #005a2f;
            color: white !important;
            margin-bottom: 1rem;
        }
        .card-header {
            background-color: #006666 !important;
            color: white !important;
            padding: 1rem;
        }
        .card-header h5 {
            color: white !important;
            margin: 0;
        }
        .card-body {
            padding: 1rem;
        }
        h2 {
            color: white !important;
            margin-bottom: 1.5rem;
        }
        .key-item {
            background-color: #005a2f;
            color: white !important;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .saved-payload-item {
            background-color: #005a2f;
            color: white !important;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .status-log {
            background-color: #005a2f;
            color: white !important;
            height: 200px;
            overflow-y: auto;
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-control {
            background-color: #005a2f;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.2);
        }
        .form-control:focus {
            background-color: #005a2f;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.1);
        }
        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.5) !important;
        }
        .form-select {
            background-color: #005a2f;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.2);
        }
        .form-select:focus {
            background-color: #005a2f;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.1);
        }
        .form-select option {
            background-color: #005a2f;
            color: white !important;
        }
        .key-selection-box {
            background-color: #005a2f;
            color: white !important;
            padding: 1rem;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 0.5rem;
        }
        .form-check {
            margin-bottom: 0.5rem;
            padding-left: 2rem;
        }
        .form-check:last-child {
            margin-bottom: 0;
        }
        .form-check-label {
            color: white !important;
            cursor: pointer;
            user-select: none;
        }
        .form-check-input {
            background-color: #006666;
            border-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }
        .form-check-input:checked {
            background-color: #048a24;
            border-color: #048a24;
        }
        .alert-info {
            background-color: #005a2f;
            color: white !important;
            border-color: #006666;
        }
        .btn-primary {
            background-color: #006666;
            border-color: #006666;
            color: white !important;
        }
        .btn-primary:hover {
            background-color: #005555;
            border-color: #005555;
        }
        .btn-primary:disabled {
            background-color: #004444;
            border-color: #004444;
        }
        .btn-success {
            background-color: #006666;
            border-color: #006666;
            color: white !important;
        }
        .btn-success:hover {
            background-color: #005555;
            border-color: #005555;
        }
        .btn-outline-primary {
            color: white !important;
            border-color: #006666;
        }
        .btn-outline-primary:hover {
            background-color: #006666;
            border-color: #006666;
        }
        .btn-danger {
            color: white !important;
        }
        .btn-danger:disabled {
            opacity: 0.65;
        }
        .btn-info {
            color: white !important;
            background-color: #006666;
            border-color: #006666;
        }
        .btn-info:hover {
            background-color: #005555;
            border-color: #005555;
            color: white !important;
        }
        .custom-details {
            background-color: #005a2f;
            padding: 1rem;
            border-radius: 5px;
            margin-top: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .countdown {
            color: white !important;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        textarea.form-control {
            min-height: 100px;
            font-family: monospace;
        }
        .payload-preview {
            background-color: #005a2f;
            color: white !important;
            padding: 1rem;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: monospace;
            white-space: pre-wrap;
        }
        .input-group > .form-control,
        .input-group > .form-select {
            background-color: #005a2f;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.2);
        }
        .hidden {
            display: none !important;
        }
        .key-selection-wrapper {
            margin-top: 0.5rem;
        }
        .key-selection-wrapper .form-check {
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Initial Setup Section -->
        <div id="setupSection" class="mb-4">
            <h2>PagerDuty Event Generator Setup</h2>
            <div class="alert alert-info">
                <h5>How to get your PagerDuty Routing/Integration Keys:</h5>
                <ol>
                    <li>Go to your sandbox services settings</li>
                    <li>Click 'Integrations'</li>
                    <li>Click 'Add Integration'</li>
                    <li>Add any integration (no need to actually integrate it)</li>
                    <li>Click on the cog icon (⚙️) on the right side of the integration bar</li>
                    <li>Copy the Integration Key</li>
                    <li>Paste it below</li>
                </ol>
            </div>
            <div class="mb-3">
                <div class="input-group">
                    <input type="text" id="newKeyInput" class="form-control" placeholder="Enter routing key">
                    <input type="text" id="newKeyName" class="form-control" placeholder="Enter key name (optional)">
                    <button onclick="addKey()" class="btn btn-primary">Add Key</button>
                </div>
            </div>
            <div id="keysList" class="mb-3"></div>
            <button onclick="saveAndContinue()" class="btn btn-success">Save and Continue</button>
        </div>

        <!-- Main Control Section -->
        <div id="controlSection" class="hidden">
            <h2>PagerDuty Event Generator</h2>

            <!-- Routing Keys Management -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Manage Routing Keys</h5>
                </div>
                <div class="card-body">
                    <div id="mainKeysList"></div>
                    <div class="input-group mt-3">
                        <input type="text" id="mainNewKeyInput" class="form-control" placeholder="Enter new routing key">
                        <input type="text" id="mainNewKeyName" class="form-control" placeholder="Enter key name (optional)">
                        <button class="btn btn-outline-primary" onclick="addKeyMain()">Add New Key</button>
                    </div>
                </div>
            </div>

            <!-- Event Generator Controls -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Event Generator Controls</h5>
                </div>
                <div class="card-body">
                    <!-- Event Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">Event Type</label>
                        <select id="eventType" class="form-select" onchange="toggleEventType()">
                            <option value="standard">Standard Random Events</option>
                            <option value="custom">Custom Events</option>
                        </select>
                    </div>

                    <!-- Standard Controls -->
                    <div id="standardControls">
                        <div class="mb-3">
                            <label class="form-label">Routing Key Selection</label>
                            <select id="keySelectionMode" class="form-select" onchange="toggleKeySelectionMode('standard')">
                                <option value="random">Random (Default)</option>
                                <option value="specific">Specific Keys</option>
                            </select>
                            <div id="specificKeySelection" class="key-selection-wrapper hidden">
                                <div class="key-selection-box">
                                    <div id="specificKeys">
                                        <!-- Checkboxes will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Run Mode</label>
                            <select id="runMode" class="form-select" onchange="toggleIterationInputs()">
                                <option value="single">Single Run</option>
                                <option value="multiple">Multiple Runs</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Event Severity</label>
                            <select id="severityMode" class="form-select">
                                <option value="random">Random (Default)</option>
                                <option value="critical">Critical</option>
                                <option value="error">Error</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                    </div>

                    <!-- Custom Event Controls -->
                    <div id="customControls" class="hidden">
                        <div class="mb-3">
                            <label class="form-label">Routing Key Selection</label>
                            <select id="customKeySelectionMode" class="form-select" onchange="toggleKeySelectionMode('custom')">
                                <option value="random">Random (Default)</option>
                                <option value="specific">Specific Keys</option>
                            </select>
                            <div id="customSpecificKeySelection" class="key-selection-wrapper hidden">
                                <div class="key-selection-box">
                                    <div id="customSpecificKeys">
                                        <!-- Checkboxes will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Saved Payloads</label>
                            <select id="savedPayloadsDropdown" class="form-select" onchange="loadSavedPayload()">
                                <option value="">Create New Payload</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Summary</label>
                            <input type="text" id="eventSummary" class="form-control" placeholder="Enter event summary">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Severity</label>
                            <select id="customSeverity" class="form-select">
                                <option value="critical">Critical</option>
                                <option value="error">Error</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Source</label>
                            <input type="text" id="eventSource" class="form-control" placeholder="Enter event source">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Group</label>
                            <input type="text" id="eventGroup" class="form-control" placeholder="Enter event group">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Component</label>
                            <input type="text" id="eventComponent" class="form-control" placeholder="Enter component name">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Class</label>
                            <input type="text" id="eventClass" class="form-control" placeholder="Enter event class">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Custom Details (JSON format)</label>
                            <textarea id="customDetailsText" class="form-control" 
                                    placeholder="Enter custom details in JSON format"
                                    onchange="updatePayloadPreview()"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Save Current Payload</label>
                            <div class="input-group">
                                <input type="text" id="payloadName" class="form-control" 
                                       placeholder="Enter name for this payload">
                                <button onclick="saveCurrentPayload()" class="btn btn-outline-primary">
                                    Save Payload
                                </button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Payload Preview</label>
                            <pre id="previewPayload" class="payload-preview"></pre>
                        </div>
                    </div>

                    <div id="iterationControls" class="hidden">
                        <div class="mb-3">
                            <label class="form-label">Number of Iterations</label>
                            <input type="number" id="iterations" class="form-control" min="1" max="100" value="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Delay Between Iterations (seconds)</label>
                            <input type="number" id="delay" class="form-control" min="0" max="3600" value="300">
                        </div>
                    </div>
                    <button onclick="startGenerator()" class="btn btn-primary">Start Generator</button>
                    <button onclick="stopGenerator()" class="btn btn-danger" disabled>Stop Generator</button>
                </div>
            </div>

            <!-- Status Log -->
            <div class="card">
                <div class="card-header">
                    <h5>Status Log</h5>
                </div>
                <div class="card-body">
                    <div id="countdown" class="countdown"></div>
                    <div id="statusLog" class="status-log"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize variables
        let routingKeys = [];
        let savedPayloads = [];
        let isRunning = false;
        let currentIteration = 0;
        let totalIterations = 0;
        let countdownInterval;
        let selectedKeysQueue = [];
        let totalSelectedKeys = 0;

        // Load saved keys and payloads on startup
        window.onload = function() {
            // Load saved routing keys
            const savedKeys = localStorage.getItem('pdRoutingKeys');
            if (savedKeys) {
                routingKeys = JSON.parse(savedKeys);
                if (routingKeys.length > 0) {
                    document.getElementById('setupSection').classList.add('hidden');
                    document.getElementById('controlSection').classList.remove('hidden');
                    updateKeysListMain();
                    updateSpecificKeyDropdown();
                }
            }
            updateKeysList();

            // Load saved payloads
            const savedPayloadsData = localStorage.getItem('pdSavedPayloads');
            if (savedPayloadsData) {
                savedPayloads = JSON.parse(savedPayloadsData);
                updateSavedPayloadsDropdown();
            }

            // Initialize event listeners
            initializeEventListeners();
        };

        function initializeEventListeners() {
            // Add event listeners for payload preview
            const previewFields = ['eventSummary', 'customSeverity', 'eventSource', 
                                 'eventGroup', 'eventComponent', 'eventClass', 'customDetailsText'];
            previewFields.forEach(field => {
                document.getElementById(field).addEventListener('input', updatePayloadPreview);
            });

            // Add event listeners for key selection modes
            document.getElementById('keySelectionMode').addEventListener('change', function() {
                toggleKeySelectionMode('standard');
            });

            document.getElementById('customKeySelectionMode').addEventListener('change', function() {
                toggleKeySelectionMode('custom');
            });
        }

        function toggleKeySelectionMode(mode) {
            const selectionMode = mode === 'standard' ? 
                document.getElementById('keySelectionMode').value :
                document.getElementById('customKeySelectionMode').value;
            
            const selectionDiv = mode === 'standard' ? 
                document.getElementById('specificKeySelection') :
                document.getElementById('customSpecificKeySelection');
            
            selectionDiv.classList.toggle('hidden', selectionMode === 'random');
            
            if (selectionMode === 'specific') {
                updateSpecificKeyDropdown();
            }
        }

        function addKey() {
            const keyInput = document.getElementById('newKeyInput');
            const nameInput = document.getElementById('newKeyName');
            const key = keyInput.value.trim();
            const name = nameInput.value.trim() || key;
            
            if (key && !routingKeys.some(k => k.key === key)) {
                routingKeys.push({ key: key, name: name });
                keyInput.value = '';
                nameInput.value = '';
                updateKeysList();
                localStorage.setItem('pdRoutingKeys', JSON.stringify(routingKeys));
            }
        }

        function addKeyMain() {
            const keyInput = document.getElementById('mainNewKeyInput');
            const nameInput = document.getElementById('mainNewKeyName');
            const key = keyInput.value.trim();
            const name = nameInput.value.trim() || key;
            
            if (key && !routingKeys.some(k => k.key === key)) {
                routingKeys.push({ key: key, name: name });
                keyInput.value = '';
                nameInput.value = '';
                updateKeysListMain();
                updateSpecificKeyDropdown();
                localStorage.setItem('pdRoutingKeys', JSON.stringify(routingKeys));
            }
        }

        function removeKey(index) {
            routingKeys.splice(index, 1);
            updateKeysList();
            updateKeysListMain();
            updateSpecificKeyDropdown();
            localStorage.setItem('pdRoutingKeys', JSON.stringify(routingKeys));
        }

        function editKeyName(index) {
            const newName = prompt('Enter new name for the key:', routingKeys[index].name);
            if (newName !== null && newName.trim() !== '') {
                routingKeys[index].name = newName.trim();
                updateKeysList();
                updateKeysListMain();
                updateSpecificKeyDropdown();
                localStorage.setItem('pdRoutingKeys', JSON.stringify(routingKeys));
            }
        }

        function updateKeysList() {
            const keysList = document.getElementById('keysList');
            keysList.innerHTML = routingKeys.map((keyObj, index) => `
                <div class="key-item">
                    <span>${keyObj.name} (${keyObj.key})</span>
                    <div>
                        <button onclick="editKeyName(${index})" class="btn btn-sm btn-info me-2">Rename</button>
                        <button onclick="removeKey(${index})" class="btn btn-sm btn-danger">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function updateKeysListMain() {
            const keysList = document.getElementById('mainKeysList');
            keysList.innerHTML = routingKeys.map((keyObj, index) => `
                <div class="key-item">
                    <span>${keyObj.name} (${keyObj.key})</span>
                    <div>
                        <button onclick="editKeyName(${index})" class="btn btn-sm btn-info me-2">Rename</button>
                        <button onclick="removeKey(${index})" class="btn btn-sm btn-danger">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function updateSpecificKeyDropdown() {
            const standardKeysHtml = routingKeys.map(keyObj => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           value="${keyObj.key}" 
                           id="standard-key-${keyObj.key}" 
                           name="specific-keys">
                    <label class="form-check-label" for="standard-key-${keyObj.key}">
                        ${keyObj.name} (${keyObj.key})
                    </label>
                </div>
            `).join('');

            const customKeysHtml = routingKeys.map(keyObj => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           value="${keyObj.key}" 
                           id="custom-key-${keyObj.key}" 
                           name="custom-specific-keys">
                    <label class="form-check-label" for="custom-key-${keyObj.key}">
                        ${keyObj.name} (${keyObj.key})
                    </label>
                </div>
            `).join('');

            document.getElementById('specificKeys').innerHTML = standardKeysHtml;
            document.getElementById('customSpecificKeys').innerHTML = customKeysHtml;
        }

        function saveAndContinue() {
            if (routingKeys.length > 0) {
                localStorage.setItem('pdRoutingKeys', JSON.stringify(routingKeys));
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('controlSection').classList.remove('hidden');
                updateKeysListMain();
                updateSpecificKeyDropdown();
            } else {
                alert('Please add at least one routing key');
            }
        }

        function toggleEventType() {
            const eventType = document.getElementById('eventType').value;
            const standardControls = document.getElementById('standardControls');
            const customControls = document.getElementById('customControls');
            
            standardControls.classList.toggle('hidden', eventType !== 'standard');
            customControls.classList.toggle('hidden', eventType !== 'custom');
            
            if (eventType === 'custom') {
                updatePayloadPreview();
            }
        }

        function toggleIterationInputs() {
            const iterationControls = document.getElementById('iterationControls');
            iterationControls.classList.toggle('hidden', 
                document.getElementById('runMode').value === 'single');
        }

function updatePayloadPreview() {
            let customDetails = {};
            try {
                const customDetailsText = document.getElementById('customDetailsText').value;
                if (customDetailsText.trim()) {
                    customDetails = JSON.parse(customDetailsText);
                }
            } catch (e) {
                customDetails = { error: "Invalid JSON format" };
            }

            const payload = {
                routing_key: "YOUR_ROUTING_KEY",
                event_action: "trigger",
                client: "KrakenDuty",
                client_url: window.location.href,
                payload: {
                    summary: document.getElementById('eventSummary').value || "Test alert",
                    severity: document.getElementById('customSeverity').value,
                    source: document.getElementById('eventSource').value || "PD Event Generator",
                    custom_details: customDetails,
                    component: document.getElementById('eventComponent').value || undefined,
                    group: document.getElementById('eventGroup').value || undefined,
                    class: document.getElementById('eventClass').value || undefined
                }
            };

            // Remove undefined fields
            Object.keys(payload.payload).forEach(key => {
                if (payload.payload[key] === undefined) {
                    delete payload.payload[key];
                }
            });

            document.getElementById('previewPayload').textContent = 
                JSON.stringify(payload, null, 2);
        }

        function saveCurrentPayload() {
            const name = document.getElementById('payloadName').value.trim();
            if (!name) {
                alert('Please enter a name for the payload');
                return;
            }

            let customDetails = {};
            try {
                const customDetailsText = document.getElementById('customDetailsText').value;
                if (customDetailsText.trim()) {
                    customDetails = JSON.parse(customDetailsText);
                }
            } catch (e) {
                alert('Invalid JSON format in custom details');
                return;
            }

            const payload = {
                name: name,
                data: {
                    summary: document.getElementById('eventSummary').value || "",
                    severity: document.getElementById('customSeverity').value,
                    source: document.getElementById('eventSource').value || "",
                    group: document.getElementById('eventGroup').value || "",
                    component: document.getElementById('eventComponent').value || "",
                    class: document.getElementById('eventClass').value || "",
                    custom_details: customDetails
                }
            };

            const existingIndex = savedPayloads.findIndex(p => p.name === name);
            if (existingIndex >= 0) {
                if (confirm('A payload with this name already exists. Do you want to update it?')) {
                    savedPayloads[existingIndex] = payload;
                } else {
                    return;
                }
            } else {
                savedPayloads.push(payload);
            }

            localStorage.setItem('pdSavedPayloads', JSON.stringify(savedPayloads));
            updateSavedPayloadsDropdown();
            document.getElementById('payloadName').value = '';
            logStatus(`Payload "${name}" saved successfully`);
        }

        function loadSavedPayload() {
            const selectedPayloadName = document.getElementById('savedPayloadsDropdown').value;
            if (!selectedPayloadName) {
                clearPayloadFields();
                return;
            }

            const payload = savedPayloads.find(p => p.name === selectedPayloadName);
            if (payload) {
                document.getElementById('eventSummary').value = payload.data.summary;
                document.getElementById('customSeverity').value = payload.data.severity;
                document.getElementById('eventSource').value = payload.data.source;
                document.getElementById('eventGroup').value = payload.data.group;
                document.getElementById('eventComponent').value = payload.data.component;
                document.getElementById('eventClass').value = payload.data.class;
                document.getElementById('customDetailsText').value = 
                    JSON.stringify(payload.data.custom_details, null, 2);
                updatePayloadPreview();
            }
        }

        function clearPayloadFields() {
            document.getElementById('eventSummary').value = '';
            document.getElementById('customSeverity').value = 'critical';
            document.getElementById('eventSource').value = '';
            document.getElementById('eventGroup').value = '';
            document.getElementById('eventComponent').value = '';
            document.getElementById('eventClass').value = '';
            document.getElementById('customDetailsText').value = '';
            updatePayloadPreview();
        }

        function updateSavedPayloadsDropdown() {
            const dropdown = document.getElementById('savedPayloadsDropdown');
            dropdown.innerHTML = '<option value="">Create New Payload</option>' +
                savedPayloads.map(payload => 
                    `<option value="${payload.name}">${payload.name}</option>`
                ).join('');
        }

        function getSelectedKeys(mode) {
            const selector = mode === 'standard' ? 'specific-keys' : 'custom-specific-keys';
            return Array.from(document.querySelectorAll(`input[name="${selector}"]:checked`))
                .map(checkbox => checkbox.value);
        }

        function startGenerator() {
            if (routingKeys.length === 0) {
                alert('Please add at least one routing key');
                return;
            }

            const eventType = document.getElementById('eventType').value;
            if (eventType === 'standard') {
                startStandardGenerator();
            } else {
                startCustomGenerator();
            }
        }

        function startStandardGenerator() {
            const keySelectionMode = document.getElementById('keySelectionMode').value;
            if (keySelectionMode === 'specific') {
                const selectedKeys = getSelectedKeys('standard');
                if (selectedKeys.length === 0) {
                    alert('Please select at least one key in specific mode');
                    return;
                }
                selectedKeysQueue = [...selectedKeys];
                totalSelectedKeys = selectedKeys.length;
            }

            isRunning = true;
            document.querySelector('button[onclick="startGenerator()"]').disabled = true;
            document.querySelector('button[onclick="stopGenerator()"]').disabled = false;

            const runMode = document.getElementById('runMode').value;
            totalIterations = runMode === 'single' ? 1 : parseInt(document.getElementById('iterations').value);
            currentIteration = 0;
            runStandardIteration();
        }

        function runStandardIteration() {
            if (!isRunning) return;

            currentIteration++;
            
            let selectedKey;
            const keySelectionMode = document.getElementById('keySelectionMode').value;
            if (keySelectionMode === 'random') {
                const randomKeyObj = routingKeys[Math.floor(Math.random() * routingKeys.length)];
                selectedKey = randomKeyObj.key;
            } else {
                if (selectedKeysQueue.length === 0) {
                    selectedKeysQueue = [...getSelectedKeys('standard')];
                }
                selectedKey = selectedKeysQueue.shift();
            }

            const keyObj = routingKeys.find(k => k.key === selectedKey);
            const keyName = keyObj ? keyObj.name : selectedKey;

            let selectedSeverity;
            const severityMode = document.getElementById('severityMode').value;
            if (severityMode === 'random') {
                const severities = ['critical', 'error', 'warning', 'info'];
                selectedSeverity = severities[Math.floor(Math.random() * severities.length)];
            } else {
                selectedSeverity = severityMode;
            }

            const scenarios = ['network', 'database', 'application', 'disk', 'login'];
            const selectedScenario = scenarios[Math.floor(Math.random() * scenarios.length)];

            logStatus(`Running iteration ${currentIteration} of ${totalIterations}`);
            logStatus(`Using routing key: ${keyName} (${selectedKey})`);
            logStatus(`Scenario: ${selectedScenario}, Severity: ${selectedSeverity}`);

            fetch('https://events.pagerduty.com/v2/enqueue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    routing_key: selectedKey,
                    event_action: "trigger",
                    payload: {
                        summary: `Test alert - ${selectedScenario}`,
                        source: "PD Event Generator",
                        severity: selectedSeverity
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                logStatus('Event sent successfully');
            })
            .catch(error => logStatus(`Error: ${error.message}`));

            if (currentIteration < totalIterations && isRunning) {
                const delay = parseInt(document.getElementById('delay').value);
                startCountdown(delay);
                setTimeout(runStandardIteration, delay * 1000);
            } else if (isRunning) {
                stopGenerator();
                logStatus('Generator completed all iterations');
            }
        }

        function startCustomGenerator() {
            const keySelectionMode = document.getElementById('customKeySelectionMode').value;
            if (keySelectionMode === 'specific') {
                const selectedKeys = getSelectedKeys('custom');
                if (selectedKeys.length === 0) {
                    alert('Please select at least one key in specific mode');
                    return;
                }
                selectedKeysQueue = [...selectedKeys];
                totalSelectedKeys = selectedKeys.length;
            }

            isRunning = true;
            document.querySelector('button[onclick="startGenerator()"]').disabled = true;
            document.querySelector('button[onclick="stopGenerator()"]').disabled = false;

            const runMode = document.getElementById('runMode').value;
            totalIterations = runMode === 'single' ? 1 : parseInt(document.getElementById('iterations').value);
            currentIteration = 0;
            runCustomIteration();
        }

        function runCustomIteration() {
            if (!isRunning) return;

            currentIteration++;
            
            let selectedKey;
            const keySelectionMode = document.getElementById('customKeySelectionMode').value;
            if (keySelectionMode === 'random') {
                const randomKeyObj = routingKeys[Math.floor(Math.random() * routingKeys.length)];
                selectedKey = randomKeyObj.key;
            } else {
                if (selectedKeysQueue.length === 0) {
                    selectedKeysQueue = [...getSelectedKeys('custom')];
                }
                selectedKey = selectedKeysQueue.shift();
            }

            const keyObj = routingKeys.find(k => k.key === selectedKey);
            const keyName = keyObj ? keyObj.name : selectedKey;

            let customDetails = {};
            try {
                const customDetailsText = document.getElementById('customDetailsText').value;
                if (customDetailsText.trim()) {
                    customDetails = JSON.parse(customDetailsText);
                }
            } catch (e) {
                logStatus('Error: Invalid JSON format in custom details');
                stopGenerator();
                return;
            }

            const payload = {
                routing_key: selectedKey,
                event_action: "trigger",
                client: "KrakenDuty",
                client_url: window.location.href,
                payload: {
                    summary: document.getElementById('eventSummary').value || "Test alert",
                    severity: document.getElementById('customSeverity').value,
                    source: document.getElementById('eventSource').value || "PD Event Generator",
                    custom_details: customDetails,
                    component: document.getElementById('eventComponent').value || undefined,
                    group: document.getElementById('eventGroup').value || undefined,
                    class: document.getElementById('eventClass').value || undefined
                }
            };

            // Remove undefined fields
            Object.keys(payload.payload).forEach(key => {
                if (payload.payload[key] === undefined) {
                    delete payload.payload[key];
                }
            });

            logStatus(`Running iteration ${currentIteration} of ${totalIterations}`);
            logStatus(`Using routing key: ${keyName} (${selectedKey})`);
            logStatus(`Sending custom payload with severity: ${payload.payload.severity}`);

            fetch('https://events.pagerduty.com/v2/enqueue', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                logStatus('Event sent successfully');
            })
            .catch(error => logStatus(`Error: ${error.message}`));

            if (currentIteration < totalIterations && isRunning) {
                const delay = parseInt(document.getElementById('delay').value);
                startCountdown(delay);
                setTimeout(runCustomIteration, delay * 1000);
            } else if (isRunning) {
                stopGenerator();
                logStatus('Generator completed all iterations');
            }
        }

        function stopGenerator() {
            isRunning = false;
            clearInterval(countdownInterval);
            document.querySelector('button[onclick="startGenerator()"]').disabled = false;
            document.querySelector('button[onclick="stopGenerator()"]').disabled = true;
            document.getElementById('countdown').innerHTML = '';
            logStatus('Generator stopped');
        }

        function startCountdown(seconds) {
            let remaining = seconds;
            document.getElementById('countdown').innerHTML = `Next iteration in: ${remaining} seconds`;

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                remaining--;
                if (remaining >= 0) {
                    document.getElementById('countdown').innerHTML = `Next iteration in: ${remaining} seconds`;
                } else {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').innerHTML = '';
                }
            }, 1000);
        }

        function logStatus(message) {
            const statusLog = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            statusLog.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }
    </script>
</body>
</html>
